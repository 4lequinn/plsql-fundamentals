
-- RESULT CACHING PERMITE QUE LOS RESULTADOS DE SQL Y PL/SQL SE ALMACENA EN UNA ZONA DE CACHÉ
-- DE ESE MODO, SI SE REALIZA LA MISMA CONSULTA O FUNCIÓN, LOS DATOS SE RECUPERAN DE LA CACHÉ, CON LO QUE 
-- EL RENDIMIENTO ES MAYOR

-- POR LO TANTO, AQUELLAS FUNCIONES PL/SQL QUE SE EJECUTAN RECURRENTEMENTE PUEDE SER MUY ÚTIL.
-- LA ZONA DE CACHÉ SE INVALIDA CUANDO EL DATO DENTRO DE UNA BASE DE DATOS SE MODIFICA.

-- SGA (SYSTEM GLOBAL ÁREA)
-- LIBRARY CACHE - RESULT CACHE - DICCIONARIO DE DATOS
-----------------------------------------------------------------

-- DESDE SYSTEM

-- MUESTRA LAS VARIABLES DE CACHE
SHOW PARAMETERS CACHE;

-- MUESTRA LA SGA DE MEMORIA
SHOW SGA;


SELECT NAME ,VALUE 
FROM v$PARAMETER WHERE  NAME LIKE '%cache%';

-- ALTERAMOS EL RESULT CACHE MAX SIZE A 100 Megas
ALTER SYSTEM SET  RESULT_CACHE_MAX_SIZE=100M;
SELECT NAME ,VALUE FROM v$PARAMETER WHERE  NAME LIKE '%cache%';


-- DEBEMOS DEJAR EN MODO MANUAL PARA QUE NOSOTROS INDIQUEMOS LAS CONSULTAS QUE SERÁN CACHEADAS.
ALTER SYSTEM SET RESULT_CACHE_MODE='MANUAL';
SELECT NAME ,VALUE FROM v$PARAMETER WHERE  NAME LIKE '%result_cache%';


-- PAQUETE RESULT CACHE

SET SERVEROUTPUT ON;


BEGIN
    -- VERIFICAMOS SI EL RESULT CACHE ESTÁ ACTIVO
    DBMS_OUTPUT.PUT_LINE(DBMS_RESULT_CACHE.STATUS);
    DBMS_RESULT_CACHE.MEMORY_REPORT;
    -- LIMPIA LA CACHE
    DBMS_RESULT_CACHE.FLUSH;
END;
/



EXECUTE DBMS_RESULT_CACHE.MEMORY_REPORT;

-- CON LA HERRAMIENTA EXPLICACIÓN DEL PLAN DE EJECUCIÓN PODEMOS VERIFICAR EL USO DE RESULT CACHE
-- HINTS
SELECT /*+ RESULT_CACHE */ *
FROM CATEGORIA;


-- COMO SYSTEM
-- VERIFICAMOS SI SE ESTÁ CACHEANDO

-- VERIFICAMOS LAS ESTADÍSTICAS
SELECT * FROM v$result_cache_statistics;

select * from table(dbms_xplan.display_cursor(sql_id=>'null', format=>'ALLSTATS LAST'))

select * from table(dbms_xplan.display_cursor(sql_id=>'f7zacbcc6uqq9', format=>'ALLSTATS LAST'));
select * from table(dbms_xplan.display_cursor(sql_id=>'f7zacbcc6uqq9', format=>'ALLSTATS LAST'));

SELECT * FROM V$RESULT_CACHE_OBJECTS;

SELECT * FROM V$RESULT_CACHE_OBJECTS WHERE CACHE_ID = '8b5jgqbnyu0qn774uft09vcfpp';

-- SI NOS INDICA PUBLISHED SE HARÁ USO DE LA CACHE


-- CACHEAR EL RESULTADO DE FUNCIONES
CREATE OR REPLACE FUNCTION CONTAR_EMPLEADOS (DEPARTMENTO NUMBER)
RETURN NUMBER
RESULT_CACHE RELIES_ON (EMPLOYEES)
IS
    NUM_EMPLE NUMBER;
BEGIN
    SELECT COUNT(*) INTO NUM_EMPLE FROM EMPLOYEES WHERE DEPARTMENT_ID=DEPARTMENTO;
    RETURN NUM_EMPLE;
END;
/


SELECT DEPARTMENT_NAME,CONTAR_EMPLEADOS(DEPARTMENT_ID) FROM DEPARTMENTS;
SELECT DEPARTMENT_NAME,CONTAR_EMPLEADOS(DEPARTMENT_ID) FROM DEPARTMENTS WHERE DEPARTMENT_ID> 5;
